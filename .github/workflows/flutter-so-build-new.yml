name: Flutter SO Build By Ð¯K

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 17

      # Step 3: Build & Release libflutter.so
      - name: Build & Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Dart Version & Flutter Version mapping
          declare -A dart_map=(
            ["3.9.2"]="3.35.3 3.35.4 3.35.5 3.35.6 3.35.7"
            ["3.9.0"]="3.35.0 3.35.1 3.35.2"
            ["3.8.1"]="3.32.1 3.32.2 3.32.3 3.32.4 3.32.5 3.32.6 3.32.7 3.32.8"
            ["3.8.0"]="3.32.0"
            ["3.7.2"]="3.29.2 3.29.3"
            ["3.7.0"]="3.29.0 3.29.1"
            ["3.6.2"]="3.27.4"
            ["3.6.1"]="3.27.2 3.27.3"
            ["3.6.0"]="3.27.0 3.27.1"
            ["3.5.4"]="3.24.4 3.24.5"
            ["3.5.3"]="3.24.3"
            ["3.5.2"]="3.24.2"
            ["3.5.1"]="3.24.1"
            ["3.5.0"]="3.24.0"
            ["3.4.4"]="3.22.3"
            ["3.4.3"]="3.22.2"
            ["3.4.1"]="3.22.1"
            ["3.4.0"]="3.22.0"
            ["3.3.4"]="3.19.6"
            ["3.3.3"]="3.19.5"
            ["3.3.2"]="3.19.4"
            ["3.3.1"]="3.19.3"
            ["3.3.0"]="3.19.0 3.19.1 3.19.2"
            ["3.2.6"]="3.16.9"
            ["3.2.5"]="3.16.8"
            ["3.2.4"]="3.16.7"
            ["3.2.3"]="3.16.3 3.16.4 3.16.6"
            ["3.2.2"]="3.16.2"
            ["3.2.1"]="3.16.1"
            ["3.2.0"]="3.16.0"
            ["3.1.5"]="3.13.9"
            ["3.1.4"]="3.13.8"
            ["3.1.3"]="3.13.6 3.13.7"
            ["3.1.2"]="3.13.5"
            ["3.1.1"]="3.13.3"
            ["3.1.0"]="3.13.0 3.13.1 3.13.2"
            ["3.0.6"]="3.10.6"
            ["3.0.5"]="3.10.5"
            ["3.0.3"]="3.10.3 3.10.4"
            ["3.0.2"]="3.10.2"
            ["3.0.1"]="3.10.1"
            ["3.0.0"]="3.10.0"
            ["2.19.6"]="3.7.9 3.7.10 3.7.11 3.7.12"
            ["2.19.5"]="3.7.8"
            ["2.19.4"]="3.7.7"
            ["2.19.3"]="3.7.6"
            ["2.19.2"]="3.7.2 3.7.3 3.7.4 3.7.5"
            ["2.19.1"]="3.7.1"
            ["2.19.0"]="3.7.0"
            ["2.18.6"]="3.3.10"
            ["2.18.5"]="3.3.9"
            ["2.18.4"]="3.3.7 3.3.8"
            ["2.18.2"]="3.3.3 3.3.4 3.3.5 3.3.6"
            ["2.18.1"]="3.3.2"
            ["2.18.0"]="3.3.0 3.3.1"
            ["2.17.6"]="3.0.5"
            ["2.17.5"]="3.0.3 3.0.4"
            ["2.17.3"]="3.0.2"
            ["2.17.1"]="3.0.1"
            ["2.17.0"]="3.0.0"
          )
          
          
          echo "## ðŸ“¦ Flutter SO Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Dart Version | Flutter Versions | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|------------------|--------|" >> $GITHUB_STEP_SUMMARY

          dart_versions=(2.17.0 2.17.1 2.17.3 2.17.5 2.17.6 2.18.0 2.18.1 2.18.2 2.18.4 2.18.5 2.18.6 2.19.0 2.19.1 2.19.2 2.19.3 2.19.4 2.19.5 2.19.6 3.0.0 3.0.1 3.0.2 3.0.3 3.0.5 3.0.6 3.1.0 3.1.1 3.1.2 3.1.3 3.1.4 3.1.5 3.2.0 3.2.1 3.2.2 3.2.3 3.2.4 3.2.5 3.2.6 3.3.0 3.3.1 3.3.2 3.3.3 3.3.4 3.4.0 3.4.1 3.4.3 3.4.4 3.5.0 3.5.1 3.5.2 3.5.3 3.5.4 3.6.0 3.6.1 3.6.2 3.7.0 3.7.2 3.8.0 3.8.1 3.9.0 3.9.2)
          summary_lines=()

          for dart_ver in "${dart_versions[@]}"; do
            RELEASE_URL="https://github.com/FlutterGenerator/Flutter-SO-Build/releases/tag/v${dart_ver}"
            echo "ðŸ” Checking existing release v${dart_ver}..."

            if gh release view "v${dart_ver}" &>/dev/null; then
              echo "âœ… Release v${dart_ver} already exists, skipping..."
              summary_lines+=("| ${dart_ver} | ${dart_map[$dart_ver]} | [âœ… Already Released](${RELEASE_URL}) |")
              continue
            fi

            echo "ðŸš€ Starting build for Dart v${dart_ver}"
            mkdir -p release/arm64 release/armeabi_v7a

            for flutter_ver in ${dart_map[$dart_ver]}; do
              echo "âš¡ Building Flutter v${flutter_ver}"
              wget -q https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_${flutter_ver}-stable.tar.xz
              tar xf flutter_linux_${flutter_ver}-stable.tar.xz
              export PATH=$PWD/flutter/bin:$PATH

              # Create test project & build APK
              flutter create flutter_so >/dev/null
              cd flutter_so
              flutter pub get
              flutter build apk --target-platform android-arm,android-arm64
              cd ..

              BASE_PATH="flutter_so/build/app/intermediates/stripped_native_libs"
              SO_ARM64=$(find "$BASE_PATH" -path "*/arm64-v8a/libflutter.so" -print -quit)
              SO_ARMEABI=$(find "$BASE_PATH" -path "*/armeabi-v7a/libflutter.so" -print -quit)

              # Save into versioned folders
              mkdir -p "release/arm64/Flutter SO [v${flutter_ver}]"
              mkdir -p "release/armeabi_v7a/Flutter SO [v${flutter_ver}]"
              cp "$SO_ARM64" "release/arm64/Flutter SO [v${flutter_ver}]/libflutter.so"
              cp "$SO_ARMEABI" "release/armeabi_v7a/Flutter SO [v${flutter_ver}]/libflutter.so"

              # Cleanup Flutter SDK & project
              rm -rf flutter flutter_so flutter_linux_${flutter_ver}-stable.tar.xz
            done

            # Prepare stylish Flutter version list for description
            flutter_list=$(echo ${dart_map[$dart_ver]} | sed 's/ /, /g')

            # Create ZIPs (clean structure)
            cd release
            cd arm64 && zip -qr ../libflutter_so_arm64.zip . && cd ..
            cd armeabi_v7a && zip -qr ../libflutter_so_armeabi_v7a.zip . && cd ..

            # Create GitHub Release
            gh release create "v${dart_ver}" \
              libflutter_so_arm64.zip \
              libflutter_so_armeabi_v7a.zip \
              --title "Dart v${dart_ver}" \
              --notes "Dart v${dart_ver} ð’ Flutter Versions: ${flutter_list}"

            cd ..
            rm -rf release

            summary_lines+=("| ${dart_ver} | ${flutter_list} | [ðŸŽ‰ Released](${RELEASE_URL}) |")
          done

          for (( idx=${#summary_lines[@]}-1 ; idx>=0 ; idx-- )); do
              echo "${summary_lines[idx]}" >> $GITHUB_STEP_SUMMARY
          done
